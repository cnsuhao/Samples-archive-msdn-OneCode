# Reg-free C# COM server (CSRegFreeCOMServer)
## Requires
* Visual Studio 2008
## License
* Apache License, Version 2.0
## Technologies
* COM
## Topics
* Interop
* Reg-free COM
## IsPublished
* True
## ModifiedDate
* 2011-05-05 05:57:29
## Description

<p style="font-family:Courier New"></p>
<h2>LIBRARY APPLICATION : CSRegFreeCOMServer Project Overview</h2>
<p style="font-family:Courier New"></p>
<h3>Summary:</h3>
<p style="font-family:Courier New"><br>
The CSRegFreeCOMServer sample demonstrates a .NET Framework-based component <br>
which is ready for registration-free activation. <br>
<br>
Registration-free COM is a mechanism available on the Microsoft Windows XP <br>
(SP2 for .NET Framework-based components), Microsoft Windows Server 2003 and <br>
newer platforms. As the name suggests, the mechanism enables easy (e.g. <br>
XCOPY) deployment of COM components to a machine without the need to register <br>
them.<br>
<br>
CSRegFreeCOMServer exposes the following component:<br>
<br>
&nbsp;Program ID: CSRegFreeCOMServer.SimpleObject<br>
&nbsp;CLSID_SimpleObject: 2384B3E7-4FFD-460d-A5B9-284182707922<br>
&nbsp;IID_ISimpleObject: 95A215C3-FC49-4f4e-9647-638521470D42<br>
&nbsp;DIID_ISimpleObjectEvents: 94BAC1E3-1172-41ee-BB83-AE451C8F3C12<br>
&nbsp;LIBID_CSRegFreeCOMServer: AD958DD7-9EA4-4123-B723-89F078FCC230<br>
<br>
&nbsp;Properties:<br>
&nbsp; &nbsp;// With both get and set accessor methods<br>
&nbsp; &nbsp;float FloatProperty<br>
<br>
&nbsp;Methods:<br>
&nbsp; &nbsp;// HelloWorld returns a string &quot;HelloWorld&quot;<br>
&nbsp; &nbsp;string HelloWorld();<br>
&nbsp; &nbsp;// GetProcessThreadID outputs the running process ID and thread ID<br>
&nbsp; &nbsp;void GetProcessThreadID(out uint processId, out uint threadId);<br>
<br>
&nbsp;Events:<br>
&nbsp; &nbsp;// FloatPropertyChanging is fired before new value is set to the <br>
&nbsp; &nbsp;// FloatProperty property. The Cancel parameter allows the client to
<br>
&nbsp; &nbsp;// cancel the change of FloatProperty.<br>
&nbsp; &nbsp;void FloatPropertyChanging(float NewValue, ref bool Cancel);<br>
<br>
NOTE: The GUIDs used in this sample are generated by guidgen.exe (Visual <br>
Studio / Tools / Create GUID). When you write your own COM objects, you need <br>
to generate and use new GUIDs.<br>
<br>
</p>
<h3>Sample Relation:</h3>
<p style="font-family:Courier New">(Relation of the current sample and other samples in
<br>
Microsoft All-In-One Code Framework <a target="_blank" href="http://cfx.codeplex.com)">
http://cfx.codeplex.com)</a><br>
<br>
CppRegFreeCOMClient -&gt; CSRegFreeCOMServer<br>
CppRegFreeCOMClient registration-free activates the .NET Framework-based <br>
component CSRegFreeCOMServer.<br>
<br>
</p>
<h3>Creation:</h3>
<p style="font-family:Courier New"><br>
A. Creating the project<br>
<br>
Step1. Create a Visual C# / Class Library project named CSRegFreeCOMServer in <br>
Visual Studio 2008.<br>
<br>
Step2. In order to make the .NET assembly COM-visible, first, open the <br>
property of the project. Click the Assembly Information button in the page, <br>
Application, and select the &quot;Make Assembly COM-Visible&quot; box. This corresponds
<br>
to the assembly attribute ComVisible in AssemblyInfo.cs:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;[assembly: ComVisible(true)]<br>
<br>
The GUID value in the dialog is the libid of the component:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;[assembly: Guid(&quot;f0998d9a-0e79-4f67-b944-9e837f479587&quot;)]<br>
<br>
So that a type library will be generated and registered at build time, set <br>
the project's Register for COM Interop setting to true in the Build page of <br>
Project Properties.<br>
<br>
B. Adding a component<br>
<br>
Step1. Define a &quot;public&quot; COM-visible interface ISimpleObject to describe
<br>
the COM interface of the coclass. Specify its GUID, aka IID, using <br>
GuidAttribute: <br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;[Guid(&quot;95A215C3-FC49-4f4e-9647-638521470D42&quot;)]<br>
<br>
In this way, IID of the COM object is a fixed value. By default, the <br>
interfaces used by a .NET Class are transformed to dual interfaces <br>
[InterfaceType(ComInterfaceType.InterfaceIsDual)] in the IDL. This allows the<br>
client to get the best of both early binding and late binding. Other options &nbsp;<br>
are [InterfaceType(ComInterfaceType.InterfaceIsIUnknown)] and <br>
[InterfaceType(ComInterfaceType.InterfaceIsIDispatch)].<br>
<br>
Step2. Inside the interface ISimpleObject, define the prototypes of the \<br>
properties and methods to be exported. The terms marked as <br>
[ComVisible(false)] are not exported.<br>
<br>
Step3. Define a &quot;public&quot; COM-visible interface ISimpleObjectEvents to <br>
describe the events the coclass can sink. Specify its GUID, aka the Events <br>
Id, using GuidAttribute:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;[Guid(&quot;94BAC1E3-1172-41ee-BB83-AE451C8F3C12&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
Decorate the interface as an IDispatch interface:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;[InterfaceType(ComInterfaceType.InterfaceIsIDispatch)]<br>
<br>
Step4. Inside the interface ISimpleObjectEvents, define the prototype of <br>
the events to be exported.<br>
<br>
Step5. Define a &quot;public&quot; COM-visible class SimpleObject that implements
<br>
the interface ISimpleObject. Attach the attribute <br>
[ClassInterface(ClassInterfaceType.None)] to it, which tells the type-library <br>
generation tools that we do not require a Class Interface. This ensures that <br>
the ISimpleObject interface is the default interface. In addition, specify <br>
the GUID of the class, aka CLSID, using the Guid attribute:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;[Guid(&quot;2384B3E7-4FFD-460d-A5B9-284182707922&quot;)]<br>
<br>
In this way, CLSID of the COM object is a fixed value. Last, decorate the <br>
class with a ComSourceInterface attribute:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;[ComSourceInterfaces(typeof(ICSExplicitInterfaceObjectEvents))]<br>
<br>
ComSourceInterfaces identifies a list of interfaces that are exposed as&nbsp;&nbsp;&nbsp;&nbsp;COM
<br>
event sources for the attributed class.<br>
<br>
Step6. Make sure that the constructor of the class SimpleObject is not <br>
private (we can either add a public constructor or use the default one), so <br>
that the COM object is creatable from the COM aware clients.<br>
<br>
Step7. Inside SimpleObject, implement the interface ISimpleObject by <br>
writing the body of the property FloatProperty and the methods HelloWorld, &nbsp;<br>
GetProcessThreadID.<br>
<br>
C. Making the assembly ready for registration-free activation<br>
<br>
You need to embed a manifest file into the assembly as a Win32 resource to <br>
make it ready for registration-free activation.<br>
<br>
Step1. Add a CSRegFreeCOMServer.manifest file to the project with this <br>
content:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;assembly xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot;
<br>
&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;manifestVersion=&quot;1.0&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;assemblyIdentity<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;type=&quot;win32&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=&quot;CSRegFreeCOMServer&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;version=&quot;1.0.0.0&quot; /&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;clrClass<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clsid=&quot;{2384B3E7-4FFD-460d-A5B9-284182707922}&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;progid=&quot;CSRegFreeCOMServer.SimpleObject&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadingModel=&quot;Both&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=&quot;CSRegFreeCOMServer.SimpleObject&quot; &gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/clrClass&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/assembly&gt;<br>
<br>
clsid=&quot;{2384B3E7-4FFD-460d-A5B9-284182707922}&quot; is the CLSID of the COM class
<br>
defined in SimpleObject.cs, and progid=&quot;CSRegFreeCOMServer.SimpleObject&quot;
<br>
is its ProgID.<br>
<br>
Step2. In the project's folder create a resource-definition script file (a <br>
text file) and call it CSRegFreeCOMServer.rc. Paste the following into the <br>
file:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;#define RT_MANIFEST 24<br>
&nbsp;&nbsp;&nbsp;&nbsp;1 RT_MANIFEST CSRegFreeCOMServer.manifest<br>
<br>
Step3. Open Project Properties, and turn to the Build Events page. In <br>
Pre-build event command line, enter this command:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@echo.<br>
&nbsp;&nbsp;&nbsp;&nbsp;IF EXIST &quot;$(DevEnvDir)..\..\..\Microsoft SDKs\Windows\v6.0A\bin\rc.exe&quot;
<br>
&nbsp;&nbsp;&nbsp;&nbsp;(&quot;$(DevEnvDir)..\..\..\Microsoft SDKs\Windows\v6.0A\bin\rc.exe&quot; /r
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;$(ProjectDir)CSRegFreeCOMServer.rc&quot;) <br>
&nbsp;&nbsp;&nbsp;&nbsp;ELSE (IF EXIST &quot;$(DevEnvDir)..\..\SDK\v2.0\Bin\rc.exe&quot;
<br>
&nbsp;&nbsp;&nbsp;&nbsp;(&quot;$(DevEnvDir)..\..\SDK\v2.0\Bin\rc.exe&quot;/r &quot;$(ProjectDir)CSRegFreeCOMServer.rc&quot;)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ELSE (IF EXIST &quot;$(DevEnvDir)..\Tools\Bin\rc.exe&quot;
<br>
&nbsp;&nbsp;&nbsp;&nbsp;(&quot;$(DevEnvDir)..\Tools\Bin\rc.exe&quot;/r &quot;$(ProjectDir)CSRegFreeCOMServer.rc&quot;)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ELSE (IF EXIST &quot;$(DevEnvDir)..\..\VC\Bin\rc.exe&quot;
<br>
&nbsp;&nbsp;&nbsp;&nbsp;(&quot;$(DevEnvDir)..\..\VC\Bin\rc.exe&quot;/r &quot;$(ProjectDir)CSRegFreeCOMServer.rc&quot;)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ELSE (@Echo Unable to find rc.exe, using default manifest instead))))<br>
&nbsp;&nbsp;&nbsp;&nbsp;@echo.<br>
<br>
The command searches for the Resource Compiler (rc.exe), and use the tool to <br>
compile the resource definition file and any resource files (binary files <br>
such as icon, bitmap, and cursor files) into a binary resource (.RES) file: <br>
CSRegFreeCOMServer.RES.<br>
<br>
Step4. Turn to the Application page of Project Properties. In the section <br>
&quot;Specify how application resources will be managed&quot;, select &quot;Resource File&quot;,
<br>
and enter the full path of CSActiveX.RES that is generated in step 3.<br>
<br>
Step5. (Optional) If you perfer a relative path to the full path of <br>
CSRegFreeCOMServer.RES, you need to modify the project file <br>
(CSRegFreeCOMServer.csproj). The &quot;Resource File&quot; value corresponds to the XML
<br>
element:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;Win32Resource&gt;CSRegFreeCOMServer.res&lt;/Win32Resource&gt;<br>
<br>
</p>
<h3>References:</h3>
<p style="font-family:Courier New"><br>
Registration-Free Activation of .NET-Based Components: A Walkthrough<br>
<a target="_blank" href="http://msdn.microsoft.com/en-us/library/ms973915.aspx">http://msdn.microsoft.com/en-us/library/ms973915.aspx</a><br>
<br>
<br>
</p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="http://bit.ly/onecodelogo">
</a></div>
